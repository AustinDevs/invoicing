<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>Payment Plan Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <style>
      input:required:invalid, input:required:focus:invalid, select:required:invalid, select:required:focus:invalid  {
        border-color: red;
      }

      input:required:focus:valid, input:required:valid, select:required:focus:valid, select:required:valid {
        border-color: green;
      }
    </style>
  </head>
  <body>
    <main class="container pt-5">
      <h1>Payment Plan Calculator Embed</h1>
      <div class="row mt-5 mb-3">
        <div class="col-lg-9">
          <div class="row">
            <div class="mb-3 col-sm-12 col-md-8 col-lg-8">
              <div class="text-center">
                <label for="start_date_range[0]" class="form-label">Start Date Range</label>
              </div>
              <div class="d-flex">
                <input type="date" class="form-control calculatable" name="start_date_range[0]" value="2023-05-30" required>
                <span>&nbsp;&nbsp;-&nbsp;&nbsp;</span>
                <input type="date" class="form-control calculatable" name="start_date_range[1]" value="2023-05-30" required>
              </div>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="final_date" class="form-label">Final Date</label>
              <input type="date" class="form-control calculatable" name="final_date" value="2023-08-30" required>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="down_payment_type" class="form-label">Down Payment Type</label>
              <select class="form-select calculatable" name="down_payment_type" required>
                <option selected value="Fixed">Fixed</option>
                <option value="Not Required">Not Required</option>
                <option value="Minimum">Minimum</option>
              </select>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="down_payment_amount" class="form-label">Down Payment</label>
              <input type="number" step="0.01" class="form-control calculatable" name="down_payment_amount" value="1000.00" required>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="down_payment_calc" class="form-label">Down Payment Calculation</label>
              <select class="form-select calculatable" name="down_payment_calc" required>
                <option selected value="amount">Amount</option>
                <option value="percent">Percent</option>
              </select>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="total" class="form-label">Total (w/o fees)</label>
              <input type="number" step="0.01" class="form-control calculatable" name="total" value="3000.00" required>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="fee" class="form-label">Fee</label>
              <input type="number" step="0.01" class="form-control calculatable" name="fee" value="200.00" required>
            </div>
            <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
              <label for="fee_calc" class="form-label">Fee Calculation</label>
              <select class="form-select calculatable" name="fee_calc" required>
                <option selected value="amount">Amount</option>
                <option value="percent">Percent</option>
              </select>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-lg-3">
          <div class="row">
            <div class="col-sm-6 col-lg-12 mb-3">
              <label for="frequency" class="form-label">Payment Frequency (multi)</label>
              <select class="form-select calculatable" multiple name="frequency" size="6" required>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="2weekly" selected>Bi-weekly</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div class="col-sm-6 col-lg-12 d-flex align-items-center">
              <label for="primary_color" class="form-label pt-1 me-1">Color</label>
              <input type="color" value="#3273dc" name="primary_color" required class="form-control calculatable" style="max-width: 100px;">
            </div>
          </div>

        </div>
      </div>
      <div class="row">
        <div class="mb-3 col-sm-6 col-md-4 col-lg-4">
          <div class="form-check">
            <input class="form-check-input calculatable" type="checkbox" name="submittable" data-bs-toggle="collapse" data-bs-target="#submittableCollapse" autocomplete="off">
            <label class="form-check-label" for="flexCheckDefault">
              Submittable
            </label>
          </div>
        </div>
      </div>
      <div class="collapse" id="submittableCollapse">
        <div class="row">
          <div class="mb-3 col-sm-6 col-md-4 col-lg-3">
            <label for="down_payment_type" class="form-label">Type</label>
            <select class="form-select submittable calculatable" name="type" required>
              <option selected value="invoice">Invoice</option>
              <option value="quote">Quote</option>
            </select>
          </div>
          <div class="mb-3 col-sm-6 col-md-4 col-lg-2">
            <label for="account_id" class="form-label">Account ID</label>
            <input type="text" class="form-control submittable calculatable" name="account_id" required>
          </div>
          <div class="mb-3 col-sm-6 col-md-4 col-lg-2">
            <label for="num_items" class="form-label">Number of Items</label>
            <input type="number" step="1" min="0" class="form-control" id="num_items" value="0" autocomplete="off" required>
          </div>
          <div class="mb-3 col-sm-6 col-md-12 col-lg-5">
            <label for="account_id" class="form-label">Line Items</label>
            <div id="line_items"></div>
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-primary mb-4" id="generate">Generate Calculator</button>
      <h2>Copy and Paste This Snippet onto your Webpage</h2>
      <code class="my-5"><pre id="embed-code" class="bg-light p-3 rounded"></pre></code>
      <h3>Preview</h3>
      <div id="paycove-iframe-container"></div>
      <code class="my-5 text-success"><pre id="output" class="bg-light p-3 rounded"></pre></code>
      <script src="https://paycove.io/js/embed.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.11.2/qs.min.js" integrity="sha512-vCegEXqPUYpZsTGz2lk0jaQ1psxtFeniVJACAXhMVxuoYa/N4nZkjoVFOxLwP7uGeQOoemiz7DQrIpRTj4IBPw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" referrerpolicy="no-referrer"></script>
      <script>
        document.querySelector('#paycove-iframe-container').innerHTML = `
          <iframe id="paycove-iframe" src="" scrolling="no" style="width: 1px; min-width: 100%; border: 0; overflow: hidden;"></iframe>
        `;
        new Paycove('#paycove-iframe', {
          onMessage: ({ message }) => document.querySelector('#output').innerText = JSON.stringify(message.payments, null, 2)
        });
        const handler = () => {
          const obj = { start_date_range: [], frequency: []};
          const submittable = document.querySelector('[name="submittable"]').checked;
          document.querySelector('#output').style.display = submittable ? 'none' : 'block';
          [...document.querySelectorAll(`.calculatable${!submittable ? ':not(.submittable)' : ''}`)].forEach(el => {
            switch (el.name) {
              case 'frequency':
                obj.frequency = Array.from(document.querySelectorAll('[name="frequency"] option:checked')).map(el => el.value)
                break;
              case 'start_date_range[0]':
                obj.start_date_range[0] = el.value;
                break;
              case 'start_date_range[1]':
                obj.start_date_range[1] = el.value;
                break;
              case 'primary_color':
                obj.primary_color = encodeURIComponent(el.value);
                break;
              case 'submittable':
                el.checked && (obj.submittable = true);
                break;
              default:
                if ((el.name.includes('quantity') || el.name.includes('price'))) {
                  const totalEl = document.querySelector('[name="total"]');
                  let total = 0;
                  [...Array(Number(document.querySelector('#num_items').value)).keys()].forEach((_, idx) => {
                    total += (Number(document.querySelector(`[name="line_items[${idx}][price]"]`).value) * Number(document.querySelector(`[name="line_items[${idx}][quantity]"]`).value))
                  });
                  totalEl.value = total;
                  obj.total = total;
                  totalEl.disabled = true;

                }
                obj[el.name] = el.value;
            }
          })
          const iframeSrc = `https://paycove.io/payment-scheduler?${Qs.stringify(obj, { arrayFormat: 'brackets', encode: false })}`;
          document.querySelector('#paycove-iframe').src = iframeSrc;
          document.querySelector('#embed-code').innerHTML = `&lt;iframe id=&quot;paycove-iframe&quot; src=&quot;${iframeSrc}&quot; scrolling=&quot;no&quot; style=&quot;width: 1px; min-width: 100%; border: 0; overflow: hidden;&quot;&gt;&lt;/iframe&gt;
&lt;script src=&quot;https://paycove.io/js/embed.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  const paycoveInt = setInterval(() => {
    if (Paycove) {
      ${submittable ? `new Paycove('#paycove-iframe');`: `new Paycove('#paycove-iframe', {
        onMessage: ({ message }) =&gt; console.log(message)
      });`}
      clearInterval(paycoveInt);
    }
  }, 1000);
&lt;/script&gt;`;
        };
        const debouncedHandler = _.debounce(handler, 1000);
        document.querySelector('#generate').addEventListener('click', debouncedHandler);
        document.querySelector('[name="submittable"]').addEventListener('click', debouncedHandler);
        const collapseHandler = (e) => {
          document.querySelector('#line_items').innerHTML = `
            ${[...Array(Number(e.target.value)).keys()].map((_, idx) => `
              <div class="input-group mb-2">
                <input type="text" name="line_items[${idx}][name]" class="form-control submittable calculatable" placeholder="Name" required>
                <input type="number" step="0.01" min="0.01" name="line_items[${idx}][price]" class="form-control submittable calculatable" placeholder="Price" required>
                <input type="number" step="1" min="1" name="line_items[${idx}][quantity]" class="form-control submittable calculatable" placeholder="Quantity" required>
              </div>
            `).join('')
          }`;
        };
        document.querySelector('#submittableCollapse').addEventListener('shown.bs.collapse', () => {
          const accountIdEl = document.querySelector('[name="account_id"]');
          if (!accountIdEl.value && Qs.parse(location.search.replace('?', '')).account_id) {
            accountIdEl.value = Qs.parse(location.search.replace('?', '')).account_id;
          }
          document.querySelector('#num_items').removeEventListener('change', collapseHandler);
          document.querySelector('#num_items').addEventListener('change', collapseHandler);
        })
      </script>
    </main>
  </body>
</html>